{extend name="common/common"} {block name="breadcrumbs"}
<ul class="breadcrumb">
    <li class="active">
        <i class="ace-icon fa fa-home home-icon"></i>
        <span _href="#">交易数据</span>
    </li>
    <li class="active">
        交易流水
    </li>
</ul>
<!-- #section:basics/content.searchbox -->
{/block}
{block name="head"}
<script src="/static/common/js/tableExport/jquery.base64.js"></script>
<script src="/static/common/js/tableExport/tableExport.js"></script>
<script type="text/javascript" src="/static/common/js/bootstrapPaginator.js"></script>
<script type="text/javascript">
	$(function(){
		check_login();
		/*alert(store_name);*/
		$("#store-name").html(store_name);
		$("#user-name").html(user_realname);		
		$("#log-off").on('click',function(){
			clear_cookie();
			$(location).attr('href', common_url+'/user/index/login');
		});
	});
</script>
{/block}
{block name="page-content"}
<!-- <ul class="nav nav-tabs">
    <li class="active">
        <a href="#">
                    流水记录
                </a>
    </li>
</ul> -->
<div class="order-body">
    <form class="form-search form-horizontal" id="searchfrom" action="javascript:thisOrderPage.doGetData(thisOrderPage.showlistpage);">
        <input type="hidden" id="page" name="page" value="1">
        <input type="hidden" name="pagesize" id="pagesize" value="10">
        <div class="row">
            <div class="col-xs-12">
                <div class="form-group col-sm-6">
                    <label class="col-sm-2 control-label">支付时间</label>
                    <div class="col-sm-6">
                        <div class="input-daterange input-group">
                            <input onFocus="WdatePicker({isShowClear:true,dateFmt:'yyyy-MM-dd',alwaysUseStartDate:false});thisOrderPage.setOn();" autocomplete="off" placeholder="开始" title="开始" name="order_addtime_s" id="order_addtime_s" value="" class="nav-search-input col-sm-12" type="text" />
                            <span class="input-group-addon">
                            <i class="fa glyphicon-minus"></i>
                            </span>
                            <input onFocus="WdatePicker({isShowClear:true,dateFmt:'yyyy-MM-dd',alwaysUseStartDate:false});thisOrderPage.setOn();" autocomplete="off" placeholder="结束" title="结束" name="order_addtime_e" id="order_addtime_e" value="" class="nav-search-input col-sm-12" type="text" />
                        </div>
                    </div>
                    <div id="quickselectdate" class="col-sm-4" style="padding-top:8px;">
                        <a href="#" onclick="$('#order_addtime_s').val('{:date('Y-m-d',time())}');$('#order_addtime_e').val('{:date('Y-m-d',time())}');thisOrderPage.setOn($(this));">今日</a>
                        <a href="#" onclick="$('#order_addtime_s').val('{:date('Y-m-d',strtotime('-1 day'))}');$('#order_addtime_e').val('{:date('Y-m-d',strtotime('-1 day'))}');thisOrderPage.setOn($(this));">昨日</a>
                        <a href="#" onclick="$('#order_addtime_s').val('{:date('Y-m-d',strtotime('-6 day'))}');$('#order_addtime_e').val('{:date('Y-m-d',time())}');thisOrderPage.setOn($(this));">最近7天</a>
                        <a href="#" onclick="$('#order_addtime_s').val('{:date('Y-m-1',strtotime('-1 month'))}');$('#order_addtime_e').val('{:date('Y-m-d',strtotime(date('Y-m-1',strtotime('-1 month')).' +1 month -1 day'))}');thisOrderPage.setOn($(this));">上个月</a>
                    </div>
                </div>
                <div class="form-group col-sm-3">
                    <label class="col-sm-4 control-label">通道</label>
                    <div class="col-sm-8" style="padding-top: 4px;">
                        <select class="chosen-select" name="order_channel_id" id="order_channel_id">
                            <option value="">不限制</option>
                            <option value="alipay">支付宝支付</option>
                            <option value="wxpay">微信支付</option>
                        </select>
                        <script type="text/javascript">
                        $("#order_channel_id").val("{:input('order_channel_id')}");
                        </script>
                    </div>
                </div>
                <div class="form-group col-sm-3">
                    <label class="col-sm-4 control-label">状态</label>
                    <div class="col-sm-8" style="padding-top: 4px;">
                        <select class="chosen-select" name="order_status" id="order_status">
                            <option value="">不限制</option>
                            <option value="ordertrue">成功交易(全额支付/部分退款)</option>
                            <option value="fundorder">退款</option>
                            <option value="orderfailed">无效交易</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group col-sm-6">
                	 <label class="col-sm-2 control-label">经营场地</label>
                    <div class="col-sm-10">                        	
                        <select data="{:input('get.order_store_id')}" name="order_store_id" id="order_store_id" onchange="thisOrderPage.storechange(this.value,0)">
                            <option value="0">全部经营场地</option>
                        </select>
                        &nbsp; 收银账号
                        <select data="{:input('get.order_user_id')}" name="order_user_id" id="order_user_id">
                            <option value="0">全部</option>
                        </select>
                    </div>
                </div>
                <div class="form-group col-sm-3">
                    <label class="col-sm-4 control-label">订单号</label>
                    <div class="col-sm-8">
                        <input name="keyword" type="text" placeholder="订单号/客户备注" class="nav-search-input col-sm-12" autocomplete="off" value="{:input('get.keyword')}" />
                    </div>
                </div>
                <div class="form-group col-sm-3">
                    <label class="col-sm-4 control-label"></label>
                    <div>
                        <button onclick="javascript:$('#pagesize').val(10);$('#page').val(0);" class="btn btn-inverse btn-sm"><i class="ace-icon fa fa-search nav-search-icon"></i>搜索</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <div class="hr hr-12"></div>
	<div style="overflow-x:auto ;">
    <table class="table table-striped table-bordered table-hover" id="reporttable">
        <thead>
            <tr>
                <th width="150">订单号</th>
                <th width="80">订单金额</th>
                <th width="100">已支付金额</th>
                <th>标题</th>
                <th>支付渠道</th>
                <th width="150"><i class="ace-icon fa fa-clock-o bigger-110 hidden-480"></i>下单时间</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="listpagebody">
        </tbody>
        <!-- <tr>
            <td title="自动递增ID:{vo.order_id}">{vo.order_num}<br />{vo.order_trade_no}</td>
            <td>{vo.order_subject}</td>
            <td align="right">{vo.order_total_amount}</td>
            <td>{vo.order_channel_id_info}</td>
            <td>{vo.order_addtime}</td>
            <td>{vo.order_pay_time}</td>
            <td>{vo.order_status_info}</td>
        </tr> -->
    </table>
	</div>
    <div class="pull-right clearfix">
        <a href="javascript:;" onclick="javascript:thisOrderPage.downloadtable();">
            <i class="ace-icon fa fa-download"></i>下载表格
        </a>
    </div>
    </form>
    <div class="pull-right ">
        <ul id="pagination" class="pagination"></ul>
    </div>
    <div class="clearfix ">
    </div>
</div>
{/block} {block name="floot"}
<script type="text/javascript">
var thisOrderPage = {
    //签约商户 的二级筛选
    shopchange: function()
    {
        var url = "{:url('api/store/getstorelist')}";
        var microtime=Date.parse(new Date())/1000;
        var postParam = {
			user_id: user_id,
			version: 1,
			time: microtime
		};
		var sign= getsign(postParam);
		postParam.sign = sign; //不这么传值下，有错误
        $.ajax(
        {
            url: url,
            data:postParam,
            type:"post",
            dateType: "json",
            success: function(data)
            {
                var html = '<option value="0">全部经营场地</option>';
                if (data.data.list.length > 0)
                {
                    data.data.list.forEach(function(obj)
                    {
                        html += '<option value="' + obj.store_id + '">' + obj.store_name + '</option>';
                    });
                }
                $("#order_store_id").html(html).val();
                //thisOrderPage.storechange(order_store_id, 0);
            }
        });
    },
    //签约商户 的三级筛选
    storechange: function()
    {
        var url = "{:url('api/store/getUserList')}";
        var order_store_id=$("#order_store_id").val();
        var microtime=Date.parse(new Date())/1000;
        var postParam = {
			user_id: user_id,
			user_store_id:order_store_id,
			version: 1,
			time: microtime
		};
		var sign= getsign(postParam);
		postParam.sign = sign; //不这么传值下，有错误
        $.ajax(
        {
            url: url,
            data:postParam,
            type:"post",
            dateType: "json",
            success: function(data)
            {
                var html = '<option value="0">全部</option>';
                if (data.data.data.length > 0)
                {
                    data.data.data.forEach(function(obj)
                    {
                        html += '<option value="' + obj.user_id + '">' + (obj.user_realname + obj.user_mobile) + '</option>';
                    });
                }
                $("#order_user_id").html(html);
                $("#order_user_id").attr("data", null); //一次性的，页面加载时有
            }
        });
    },
    downloadtable:function(){
        $('#pagesize').val(5000);
        window.dodownloadtable=true;
        $("#searchfrom").submit();
    },
    selectinit: function()
    {
            var order_shop_id =user_store_id;
            thisOrderPage.shopchange();
    },
    setOn: function(thisJqObj)
    {
        $("#quickselectdate").find(".badge").removeClass("badge");
        thisJqObj && thisJqObj.addClass("badge");
    },
    //获取数据
    doGetData: function(callBack)
    {
        thisOrderPage.showlistpageInit();
        var index = layer.load(1,
        {
            shade: [0.1, '#fff'] //0.1透明度的白色背景
        });
         var order_status=$("#order_status").val();
         var page=$("#page").val();
         var per_page=$("#pagesize").val();
         var order_num= $("input[name='keyword']").val();         
         var microtime=Date.parse(new Date())/1000;
         var order_addtime_from=$('#order_addtime_s').val();
         var order_addtime_end=$('#order_addtime_e').val();                  
         var store_id=$("#order_store_id").val();         
         var channel=$("#order_channel_id").val();
         var sale_id=$("#order_user_id").val();
         var postParam = {
				order_status: order_status,				
				per_page: per_page,
				order_num: order_num,
				user_id: user_id,
				version: 1,
				time: microtime
			};
		if(order_addtime_from.length > 0)
		{
			postParam.order_addtime_from = order_addtime_from;
		}
		if(order_addtime_end.length > 0)
		{
			postParam.order_addtime_end = order_addtime_end;
		}
		if(page > 0)
		{
			postParam.page = page;
		}
		if(store_id > 0)
		{
			postParam.store_id = store_id;
		}
		if(channel.length > 0)
		{
			postParam.channel = channel;
		}
		if(sale_id > 0)
		{
			postParam.sale_id = sale_id;
		}
		var sign= getsign(postParam);
		postParam.sign = sign;
        $.ajax(
        {
            url: "{:url('api/order/list')}",
            data:postParam,
            type:"post",
            dataType: "json",
            success: function(rs)
            {
                layer.close(index);
                callBack && callBack(rs);
                if(rs.code==0)
                {
                    layer.alert(rs.message);
                }
            },
            error: function()
            {
                layer.close(index);
            }
        })
    },
    //列表页初始化
    showlistpageInit: function()
    {
        $("#listpagebody").html("");
    },
    //列表页展示
    showlistpage: function(rs)
    {
        if (rs.data.total > 0)
        {
            var innertHTML = "";
            rs.data.data.forEach(function(one)
            {
            	var html_url="order_detail/order_num/"+one.order_num;
				var return_html_url="order_return/order_num/"+one.order_num;
                innertHTML += "<tr>";
                innertHTML += '<td title="自动递增ID:' + one.order_id + '">' + one.order_num + '</td>';
                innertHTML += '<td align="right">' + one.order_total_amount + '</td>';
                innertHTML += '<td align="right">' + one.order_pay_realprice + '</td>';
                innertHTML += '<td>' + one.order_subject;
                if(one.order_guest_brief!=''){
                    innertHTML +='<br >备注:'+one.order_guest_brief;
                }
                innertHTML +='</td>';
                innertHTML += '<td>' + one.order_channel_info + '</td>';
                innertHTML += '<td>' + one.order_addtime + '</td>';
                innertHTML += '<td>' + one.order_status_info + '</td>';
                innertHTML += '<td><a class="btn btn-xs btn-success btn-detail" href="'+html_url+'">详情</a> ';
                // if(one.order_status == 100 || one.order_status == 101)
				// {
				// 	innertHTML += '<a class="btn btn-xs btn-danger btn-money-back" href="'+return_html_url+'">退款</a>';
                //
				// }
                innertHTML += "</td></tr>";
            });
            $("#listpagebody").html(innertHTML);
            var options = {
                currentPage: rs.data.current_page, //设置当前页，默认起始页为第一页
                totalPages: Math.ceil(rs.data.total / rs.data.per_page), //总页数
                numberOfPages: 5, //设置控件显示的页码数,跟后台计算出来的总页数没多大关系
                bootstrapMajorVersion: 3, //如果是bootstrap3版本需要加此标识，并且设置包含分页内容的DOM元素为UL,如果是bootstrap2版本，则DOM包含元素是DIV
                useBootstrapTooltip: 'true', //是否显示tip提示框
                pageUrl: function(type, page, current)
                {
                    return 'javascript:$("#page").val(' + page + ');$("#searchfrom").submit();' //为每个页码设置url访问请求链接，page为页码数
                },
                itemTexts: function(type, page, current)
                { //文字翻译
                    switch (type)
                    {
                        case "first":
                            return "首页";
                        case "prev":
                            return "上一页";
                        case "next":
                            return "下一页";
                        case "last":
                            return "尾页";
                        case "page":
                            return page;
                    }
                }
            }
            $('#pagination').bootstrapPaginator(options);
            $('#pagination').prepend("总" + rs.data.total + "条记录<br />");
        }
        else
        {
            $("#listpagebody").html("<tr><td colspan='8'>没有数据</td> </tr>");
            $('#pagination').html("");
            layer.msg("没有数据");
        }
        //下载表格
        if((window.dodownloadtable||false) ==true)
        {
            $("#reporttable").tableExport({type:'excel',fileName:$('#order_addtime_s').val()+"_"+ $('#order_addtime_e').val() +"_交易明细",escape:'false'});
        }
        window.dodownloadtable = false;
        //__下载表格
    }
};
thisOrderPage.selectinit();
$(document).ready(function(){
    //$("#quickselectdate a").eq(0).click();
    $("#searchfrom").submit();
})
</script>
{/block}