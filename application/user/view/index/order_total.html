{extend name="common/common"} {block name="breadcrumbs"}
<ul class="breadcrumb">
    <li class="active">
        <i class="ace-icon fa fa-home home-icon"></i>
        <span _href="#">交易数据</span>
    </li>
    <li class="active">
        交易统计
    </li>
</ul>
{/block} 
{block name="head"}
<script src="/static/common/js/tableExport/jquery.base64.js"></script>
<script src="/static/common/js/tableExport/tableExport.js"></script>
<script type="text/javascript" src="/static/common/js/bootstrapPaginator.js"></script>
<script type="text/javascript">
	$(function(){
		check_login();
		/*alert(store_name);*/
		$("#store-name").html(store_name);
		$("#user-name").html(user_realname);		
		$("#log-off").on('click',function(){
			clear_cookie();
			$(location).attr('href', common_url+'/user/index/login');
		});
	});
</script>
<style>
		
	.grid3:first-child{
		background-image:url('../../../static/dl/assets/images/tjbj5.png') ;
		background-repeat: repeat;
		background-size: cover;
		border-radius: 20px;
		width: 28%;
		margin: 2%;
	}
	.grid3:nth-child(2){
		background-image:url('../../../static/dl/assets/images/tjbj6.png') ;
		background-repeat: repeat;
		background-size: cover;
		border-radius: 20px;
		width: 28%;
		margin:2%;
	}
	.grid3:nth-child(3){
		background-image:url('../../../static/dl/assets/images/tjbj7.png') ;
		background-repeat: repeat;
		background-size: cover;
		border-radius: 20px;
		width: 28%;
		margin: 2%;
	}
	.grid3{
		padding: 20px!important;
		font-size: 20px;
		color: white;
	}
	.grid3 span{
		color:white!important;
		font-size: 26px!important;
	}
	
</style>
{/block}
{block name="page-content"}
<div>
	<form class="form-search form-horizontal" id="searchfrom" action="javascript:thisOrderPage.doGetData(thisOrderPage.showlistpage);">
        <div class="row">
            <div class="col-xs-12">
                <div class="form-group col-sm-6">
                    <label class="col-sm-2 control-label">支付时间</label>
                    <div class="col-sm-6">
                        <div class="input-daterange input-group">
                            <input onFocus="WdatePicker({isShowClear:true,dateFmt:'yyyy-MM-dd',alwaysUseStartDate:false});thisOrderPage.setOn();" placeholder="开始" title="开始" name="order_addtime_s" id="order_addtime_s" value="" class="nav-search-input col-sm-12" type="text" />
                            <span class="input-group-addon">
                            <i class="fa glyphicon-minus"></i>
                            </span>
                            <input onFocus="WdatePicker({isShowClear:true,dateFmt:'yyyy-MM-dd',alwaysUseStartDate:false});thisOrderPage.setOn();" placeholder="结束" title="结束" name="order_addtime_e" id="order_addtime_e" value="" class="nav-search-input col-sm-12" type="text" />
                        </div>
                    </div>
                    <div id="quickselectdate" class="col-sm-4" style="padding-top:8px;">
                        <a href="#" onclick="$('#order_addtime_s').val('{:date('Y-m-d',time())}');$('#order_addtime_e').val('{:date('Y-m-d',time())}');thisOrderPage.setOn($(this));">今日</a>
                        <a href="#" onclick="$('#order_addtime_s').val('{:date('Y-m-d',strtotime('-1 day'))}');$('#order_addtime_e').val('{:date('Y-m-d',strtotime('-1 day'))}');thisOrderPage.setOn($(this));">昨日</a>
                        <a href="#" onclick="$('#order_addtime_s').val('{:date('Y-m-d',strtotime('-6 day'))}');$('#order_addtime_e').val('{:date('Y-m-d',time())}');thisOrderPage.setOn($(this));">最近7天</a>
                        <a href="#" onclick="$('#order_addtime_s').val('{:date('Y-m-1',strtotime('-1 month'))}');$('#order_addtime_e').val('{:date('Y-m-d',strtotime(date('Y-m-1',strtotime('-1 month')).' +1 month -1 day'))}');thisOrderPage.setOn($(this));">上个月</a>
                    </div>
                </div>
                <div class="form-group col-sm-3">
                    <label class="col-sm-4 control-label">通道</label>
                    <div class="col-sm-8" style="padding-top: 4px;">
                        <select class="chosen-select" name="order_channel_id" id="order_channel_id">
                            <option value="">不限制</option>
                            <option value="alipay">支付宝支付</option>
                            <option value="wxpay">微信支付</option>
                        </select>
                        <script type="text/javascript">
                        $("#order_channel_id").val("{:input('order_channel_id')}");
                        </script>
                    </div>
                </div>
                <div class="form-group col-sm-3">
                    <label class="col-sm-4 control-label">状态</label>
                    <div class="col-sm-8" style="padding-top: 4px;">
                        <select class="chosen-select" name="order_status" id="order_status">
                            <option value="">不限制</option>
                            <option value="ordertrue">成功交易(全额支付/部分退款)</option>
                            <option value="fundorder">退款</option>
                            <option value="orderfailed">无效交易</option>
                        </select>
                        <script type="text/javascript">
	                        $("#order_status").val("{:input('order_status','ordertrue')}");
	                    </script>
                    </div>                    
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group col-sm-6">
                	 <label class="col-sm-2 control-label">经营场地</label>
                    <div class="col-sm-10">                        	
                        <select data="{:input('get.order_store_id')}" name="order_store_id" id="order_store_id" onchange="thisOrderPage.storechange(this.value,0)">
                            <option value="0">全部经营场地</option>
                        </select>
                        &nbsp; 收银账号
                        <select data="{:input('get.order_user_id')}" name="order_user_id" id="order_user_id">
                            <option value="0">全部</option>
                        </select>
                    </div>
                </div>                
                <div class="form-group col-sm-3">
                    <label class="col-sm-4 control-label"></label>
                    <div>
                        <button onclick="javascript:;" class="btn btn-inverse btn-sm"><i class="ace-icon fa fa-search nav-search-icon"></i>搜索</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <div class="hr hr-12"></div>
    <table class="table table-striped table-bordered table-hover" id="reporttable">
        <thead>
            <tr>
                <th width="">日期</th>
                <th width="">总金额</th>
                <th>收银员</th>
                <th width="">支付宝</th>
                <th>微信</th>
            </tr>
        </thead>
        <tbody id="listpagebody">
        </tbody>
        <!-- <tr>
            <td title="自动递增ID:{vo.order_id}">{vo.order_num}<br />{vo.order_trade_no}</td>
            <td>{vo.order_subject}</td>
            <td align="right">{vo.order_total_amount}</td>
            <td>{vo.order_channel_id_info}</td>
            <td>{vo.order_addtime}</td>
            <td>{vo.order_pay_time}</td>
            <td>{vo.order_status_info}</td>
        </tr> -->
    </table>
    <div class="alert no-margin clearfix" id="box_tj">
        <div class="grid3">
            ¥<span id="text_total" class="bigger-175 blue">0</span><br>总金额
        </div>
        <div class="grid3">
            ¥<span id="text_zfb_total" class="bigger-175 blue">0</span><br>支付宝总金额
        </div>
        <div class="grid3">
            ¥<span id="text_wx_total" class="bigger-175 blue">0</span><br>微信总金额
        </div>
    </div>
    <div class="pull-right clearfix">
        <a href="javascript:;" onclick="javascript:thisOrderPage.downloadtable();">
            <i class="ace-icon fa fa-download"></i>下载表格
        </a>
    </div>
    </form>
    <div class="clearfix ">
    </div>
</div>
{/block}
 {block name="floot"}
<script type="text/javascript">
var thisOrderPage = {
    //签约商户 的二级筛选
    shopchange: function()
    {
        var url = "{:url('api/store/getstorelist')}";
        var microtime=Date.parse(new Date())/1000;
        var postParam = {
			user_id: user_id,
			version: 1,
			time: microtime
		};
		var sign= getsign(postParam);
		postParam.sign = sign; //不这么传值下，有错误
        $.ajax(
        {
            url: url,
            data:postParam,
            type:"post",
            dateType: "json",
            success: function(data)
            {
                var html = '<option value="0">全部经营场地</option>';
                if (data.data.list.length > 0)
                {
                    data.data.list.forEach(function(obj)
                    {
                        html += '<option value="' + obj.store_id + '">' + obj.store_name + '</option>';
                    });
                }
                $("#order_store_id").html(html).val();
                //thisOrderPage.storechange(order_store_id, 0);
            }
        });
    },
    //签约商户 的三级筛选
    storechange: function()
    {
        var url = "{:url('api/store/getUserList')}";
        var order_store_id=$("#order_store_id").val();
        var microtime=Date.parse(new Date())/1000;
        var postParam = {
			user_id: user_id,
			user_store_id:order_store_id,
			version: 1,
			time: microtime
		};
		var sign= getsign(postParam);
		postParam.sign = sign; //不这么传值下，有错误
        $.ajax(
        {
            url: url,
            data:postParam,
            type:"post",
            dateType: "json",
            success: function(data)
            {
                var html = '<option value="0">全部</option>';
                if (data.data.data.length > 0)
                {
                    data.data.data.forEach(function(obj)
                    {
                        html += '<option value="' + obj.user_id + '">' + (obj.user_realname + obj.user_mobile) + '</option>';
                    });
                }
                $("#order_user_id").html(html);
                $("#order_user_id").attr("data", null); //一次性的，页面加载时有
            }
        });
    },
    downloadtable:function(){
        $('#pagesize').val(5000);
        window.dodownloadtable=true;
        $("#searchfrom").submit();
    },
    selectinit: function()
    {
            var order_shop_id =user_store_id;
            thisOrderPage.shopchange();
    },
    setOn: function(thisJqObj)
    {
        $("#quickselectdate").find(".badge").removeClass("badge");
        thisJqObj && thisJqObj.addClass("badge");
    },
    //获取数据
    doGetData: function(callBack)
    {
        thisOrderPage.showlistpageInit();
        var index = layer.load(1,
        {
            shade: [0.1, '#fff'] //0.1透明度的白色背景
        });
         var order_status=$("#order_status").val();
         var microtime=Date.parse(new Date())/1000;
         var order_addtime_from=$('#order_addtime_s').val();
         var order_addtime_end=$('#order_addtime_e').val();                  
         var store_id=$("#order_store_id").val();         
         var channel=$("#order_channel_id").val();
         var sale_id=$("#order_user_id").val();
         var postParam = {
				order_status: order_status,				
				user_id: user_id,
				version: 1,
				time: microtime
			};
		if(order_addtime_from.length > 0)
		{
			postParam.order_addtime_from = order_addtime_from;
		}
		if(order_addtime_end.length > 0)
		{
			postParam.order_addtime_end = order_addtime_end;
		}
		if(store_id > 0)
		{
			postParam.store_id = store_id;
		}
		if(channel.length > 0)
		{
			postParam.channel = channel;
		}
		if(sale_id > 0)
		{
			postParam.sale_id = sale_id;
		}
		var sign= getsign(postParam);
		postParam.sign = sign;
        $.ajax(
        {
            url: "{:url('api/order/ordersstatisticsforpc')}",
            data:postParam,
            type:"post",
            dataType: "json",
            success: function(rs)
            {
                layer.close(index);
                callBack && callBack(rs);
                if(rs.code==0)
                {
                    layer.alert(rs.message);
                }
            },
            error: function()
            {
                layer.close(index);
            }
        })
    },
    //列表页初始化
    showlistpageInit: function()
    {
        $("#listpagebody").html("");
        document.querySelector("#text_total").innertHTML = "0";
        document.querySelector("#text_zfb_total").innertHTML = "0";
        document.querySelector("#text_wx_total").innertHTML = "0";
    },
    //列表页展示
    showlistpage: function(rs)
    {
        if (rs.data.total > 0)
        {
            var innertHTML = "";
            var date_between=rs.data.date_between;
            rs.data.list.forEach(function(one)
            {
                innertHTML += "<tr>";
                innertHTML += '<td>' + date_between+ '</td>';
                innertHTML += '<td align="right">' + one.total_count + '</td>';
                innertHTML += '<td align="right">' + one.user_info.user_realname+one.user_info.user_mobile+'</td>';
                innertHTML += '<td>' + one.alipay_total + '</td>';
                innertHTML += '<td>' + one.wxpay_total + '</td>';
                innertHTML += "</tr>";
            });
            $("#listpagebody").html(innertHTML);  
            $("#text_total").html(rs.data.order_total);//总佣金
            $("#text_zfb_total").html(rs.data.order_total_alipay);//支付宝总金额
            $("#text_wx_total").html(rs.data.order_total_wxpay);//微信总金额
        }
        else
        {
            $("#listpagebody").html("<tr><td colspan='8'>没有数据</td> </tr>");
            $("#text_total").html("0");//总佣金
            $("#text_zfb_total").html("0");//支付宝总金额
            $("#text_wx_total").html("0");//微信总金额
            layer.msg("没有数据");           
        }
        //下载表格
        if((window.dodownloadtable||false) ==true)
        {
            $("#reporttable").tableExport({type:'excel',fileName:$('#order_addtime_s').val()+"_"+ $('#order_addtime_e').val() +"_交易明细",escape:'false'});
        }
        window.dodownloadtable = false;
        //__下载表格
    }
};
thisOrderPage.selectinit();
$(document).ready(function(){
    $("#quickselectdate a").eq(0).click();
    $("#searchfrom").submit();
})
</script>
{/block}