{extend name="common/common"} {block name="breadcrumbs"}
<ul class="breadcrumb">
	<li class="active">
		<i class="ace-icon fa fa-home home-icon"></i>
		<span _href="#">经营场地信息</span>
	</li>
	<li class="active">
		收银账号列表
	</li>

</ul>
<div class="nav-search nav-positions" id="nav-search">
	<form class="form-search form-inline" id="searchfrom" action="javascript:thisUserPage.doGetData(thisUserPage.showlistpage);">
		<input type="hidden" id="page" name="page" value="1">
        <input type="hidden" name="pagesize" id="pagesize" value="10">
		<label>经营场地</label>
		    <select data="{:input('get.order_store_id')}" name="order_store_id" id="order_store_id">
                            <option value="0">全部经营场地</option>
            </select>
            <button class="btn btn-info btn-xs" id="btn-search">查询</button>
        <a href="#" class="btn btn-info btn-xs btn-add" id="btn-add"><i class="glyphicon glyphicon-plus btn-add"></i>新增</a>
	</form>
</div>

{/block} 
{block name="head"}
<script src="/static/common/js/tableExport/jquery.base64.js"></script>
<script src="/static/common/js/tableExport/tableExport.js"></script>
<script type="text/javascript" src="/static/common/js/bootstrapPaginator.js"></script>
<script type="text/javascript">
	$(function(){
		check_login();
		/*alert(store_name);*/
		$("#store-name").html(store_name);
		$("#user-name").html(user_realname);		
		$("#log-off").on('click',function(){
			clear_cookie();
			$(location).attr('href', common_url+'/user/index/login');
		});
	});
</script>
{/block}
{block name="page-content"}
<!-- PAGE CONTENT BEGINS -->
<!--bof list-->

<div class="userlist-body">
<div class="col-xs-12">
	<div class="row">
		<table id="store_table" class="table table-striped table-bordered table-hover">
			<thead>
				<tr>
					<th width="">名称</th>
					<th width="">角色</th>
					<th width="">二维码</th>
					<th>新增时间</th>
					<th width="">操作</th>
				</tr>
			</thead>
			<tbody id="listpagebody">
       		</tbody>			
		</table>
		<div class="pull-right ">
	        <ul id="pagination" class="pagination"></ul>
	    </div>
	</div>
</div>
<!--eof list-->
<div class="space-10"></div>
<script type="text/javascript">
var thisUserPage = {
	//所有店铺
    shopchange: function()
    {
        var url = "{:url('api/store/getstorelist')}";
        var microtime=Date.parse(new Date())/1000;
        var postParam = {
			user_id: user_id,
			version: 1,
			time: microtime
		};
		var sign= getsign(postParam);
		postParam.sign = sign; //不这么传值下，有错误
        $.ajax(
        {
            url: url,
            data:postParam,
            type:"post",
            dateType: "json",
            success: function(data)
            {
                var html = '<option value="0">全部经营场地</option>';
                if (data.data.list.length > 0)
                {
                    data.data.list.forEach(function(obj)
                    {
                        html += '<option value="' + obj.store_id + '">' + obj.store_name + '</option>';
                    });
                }
                $("#order_store_id").html(html).val();
                //thisOrderPage.storechange(order_store_id, 0);
            }
        });
    },
    selectinit: function()
    {
            thisUserPage.shopchange();
    },
    //获取数据
    doGetData: function(callBack)
    {
        thisUserPage.showlistpageInit();
        var index = layer.load(1,
        {
            shade: [0.1, '#fff'] //0.1透明度的白色背景
        });
        var page=$("#page").val();
        var per_page=$("#pagesize").val();
        var user_store_id=$("#order_store_id").val();
        var microtime=Date.parse(new Date())/1000;
        var postParam = {
			user_id: user_id,
			version: 1,
			page:page,
			per_page:per_page,
			time: microtime
		};
		if(user_store_id>0){
			postParam.user_store_id=user_store_id;
		}
		var sign= getsign(postParam);
		postParam.sign = sign; //不这么传值下，有错误
		$.ajax(
        {
            url: "{:url('api/store/getUserList')}",
            data:postParam,
            type:"post",
            dataType: "json",
            success: function(rs)
            {
                layer.close(index);
                callBack && callBack(rs);
                if(rs.code==0)
                {
                    layer.alert(rs.message);
                }
            },
            error: function()
            {
                layer.close(index);
            }
        })
    },
    //列表页初始化
    showlistpageInit: function()
    {
        $("#listpagebody").html("");
    },
    //列表页展示
    showlistpage: function(rs)
    {
        if (rs.data.total > 0)
        {
            var innertHTML = "";
            rs.data.data.forEach(function(item)
            {
            	var skew="{:request()->domain().url(\"cmd/oauth/qrcode\")}?uid="+item.user_id;
				var qrcode="{:url(\"qrcode\")}";
				    innertHTML += '<tr id="' + item.user_id + '">';											
					innertHTML +='<td>' + item.user_realname + '</td>' ;
					innertHTML +='<td>'+item.user_role_name+'</td>' ;
                    if(item.user_play_reward == 1){
                        var skew_reward="{:request()->domain().url(\"cmd/oauth/qrcode\")}?reward=1&uid="+item.user_id;
                        var dashang='<div><p>'+item.user_realname +'收款二维码</p></div>   <img src="/static/common/image/qrcode.png"> <p> <a title="'+item.user_realname +'的收款二维码" href="javascript:;" data-src=\'' + skew_reward + '\' onclick="javascript:layer.open({type: 1,title:this.getAttribute(\'title\'),closeBtn: 1,shadeClose: true,content: \'<div class=center><img width=200 src='+qrcode+'?value=\'+ this.getAttribute(\'data-src\') +\'  /></div> \'});">查看</a><a target="_blank" href="'+qrcode+'?size=30&downloadname='+item.user_realname+'的收款二维码&value='+skew_reward+'">下载</a> </p>    </div>';
                    }else{
                        var dashang='';
                    }
					innertHTML +='<td align="center"><div class="row"> <div class="col-sm-6 center"><div><p>'+item.user_realname +'收款二维码</p></div>   <img src="/static/common/image/qrcode.png"> <p> <a title="'+item.user_realname +'的收款二维码" href="javascript:;" data-src=\'' + skew + '\' onclick="javascript:layer.open({type: 1,title:this.getAttribute(\'title\'),closeBtn: 1,shadeClose: true,content: \'<div class=center><img width=200 src='+qrcode+'?value=\'+ this.getAttribute(\'data-src\') +\'  /></div> \'});">查看</a><a target="_blank" href="'+qrcode+'?size=30&downloadname='+item.user_realname+'的收款二维码&value='+skew+'">下载</a> </p>    </div> <div class="col-sm-6"> '+dashang+' </div>  </div> </td>' ;
					innertHTML +='<td>' + item.user_addtime + '</td>' ;
					innertHTML +='<td><div class="btn-group"><a data-id="' + item.user_id + '" class="btn btn-xs btn-success btn-detail" href="/user/index/user_detail/current_user_id/'+item.user_id +'">详情</a><a data-id="' + item.user_id + '" class="btn btn-xs btn-success btn-detail btn-del" href="#">删除</a></div></td>';
					innertHTML +='</tr>';
            });
            console.log(rs.data.data);
            $("#listpagebody").html(innertHTML);
            var options = {
                currentPage: rs.data.current_page, //设置当前页，默认起始页为第一页
                totalPages: Math.ceil(rs.data.total / rs.data.per_page), //总页数
                numberOfPages: 5, //设置控件显示的页码数,跟后台计算出来的总页数没多大关系
                bootstrapMajorVersion: 3, //如果是bootstrap3版本需要加此标识，并且设置包含分页内容的DOM元素为UL,如果是bootstrap2版本，则DOM包含元素是DIV
                useBootstrapTooltip: 'true', //是否显示tip提示框
                pageUrl: function(type, page, current)
                {
                    return 'javascript:$("#page").val(' + page + ');$("#searchfrom").submit();' //为每个页码设置url访问请求链接，page为页码数
                },
                itemTexts: function(type, page, current)
                { //文字翻译
                    switch (type)
                    {
                        case "first":
                            return "首页";
                        case "prev":
                            return "上一页";
                        case "next":
                            return "下一页";
                        case "last":
                            return "尾页";
                        case "page":
                            return page;
                    }
                }
            }
            $('#pagination').bootstrapPaginator(options);
            $('#pagination').prepend("总" + rs.data.total + "条记录<br />");
        }
        else
        {
            $("#listpagebody").html("<tr><td colspan='8'>没有数据</td> </tr>");
            $('#pagination').html("");
            layer.msg("没有数据");
        }
        //下载表格
        if((window.dodownloadtable||false) ==true)
        {
            $("#reporttable").tableExport({type:'excel',fileName:$('#order_addtime_s').val()+"_"+ $('#order_addtime_e').val() +"_交易明细",escape:'false'});
        }
        window.dodownloadtable = false;
        //__下载表格
    }
};
thisUserPage.selectinit();
$(document).ready(function(){
    //$("#quickselectdate a").eq(0).click();
    var microtime=Date.parse(new Date())/1000;
    $("#searchfrom").submit();
    $("#listpagebody").on("click",'.btn-del',function(){
	        	var current_user_id=$(this).data("id");
	        	var postParam = {
					user_id: user_id,
					current_user_id:current_user_id,
					version: 1,
					time: microtime
				};
				var sign= getsign(postParam);
				postParam.sign = sign; //不这么传值下，有错误
				$.ajax({
					type:"post",
					url:"{:url('api/store/deleteuserone')}",
					data:postParam,
					async:true,
					dataType:"json",
					success:function(res){
						if(res.code>0){
							alert(res.message);
							$(location).attr('href', common_url+'/user/index/user_list');
						}else{
							alert(res.message);
						}
					}				
				});
	        });
    $("#btn-add").on("click",function(){
    	
		var postParam = {
			user_id: user_id,
			user_store_id:user_store_id,
			version: 1,
			time: microtime
		};
		var sign= getsign(postParam);
		postParam.sign = sign; //不这么传值下，有错误
		$.ajax({
			type:"post",
			url:"{:url('api/store/useraddone')}",
			data:postParam,
			async:true,
			dataType:"json",
			success:function(res){
				if(res.code>0){
					$(location).attr('href', common_url+'/user/index/user_add');
				}else{
					alert(res.message);
				}
			}				
		});
    })
})
</script>
</div>
<!-- PAGE CONTENT ENDS -->
{/block}