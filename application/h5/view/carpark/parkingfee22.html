<!DOCTYPE html><html>    <head>        <title>车费详情</title>        <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />        <meta name="apple-mobile-web-app-capable" content="yes">        <meta name="apple-mobile-web-app-status-bar-style" content="black">        <meta content="telephone=no" name="format-detection" />        <meta content="email=no" name="format-detection" />        <link rel="stylesheet" type="text/css" href="https://res.wx.qq.com/open/libs/weui/1.1.2/weui.min.css">        <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.0/css/jquery-weui.min.css">        <style type="text/css">        body {            margin: 0;            background: #f5f5f9;        }                p {            margin: 0;        }                .top {            padding: 18px 14px 20px 14px;            background: #FFFFFF;        }                .top .name {            margin: 0;            text-align: center;            font-size: 16px;            line-height: 1rem;            color: #3e3e3e;        }                .top .logo {            display: inline-block;            margin-right: 10px;            border-radius: 50%;            width: 1.43rem;            height: 1.43rem;            overflow: hidden;            vertical-align: -0.45rem;        }                .top .logo img {            display: block;            max-width: 100%;        }                .top .money {            margin-top: 0.5rem;            text-align: center;            font-size: 1.25rem;            line-height: 1.25rem;            color: #000000;        }                .top .stateinfo {            margin-top: 0.5rem;            text-align: center;            font-size: 14px;            line-height: 1.25rem;            color: #000000;        }                .list {            position: relative;            padding: 0 14px;            background: #FFFFFF;            font-size: 0.625rem;        }                .list.on {            border-top: solid #f1f1f1 1px;        }                .list .item {            height: 1.885rem;            line-height: 1.885rem;            overflow: hidden;        }                .list .l {            color: #adadad;            font-weight: 100;        }                .list .r {            float: right;            color: #000;        }                .msg {            padding-left: 1.125rem;            margin: 1rem 14px 0 14px;            font-size: 0.625rem;            line-height: 1rem;            color: #bdbdbe;            background: url('data:image/png;base64,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')no-repeat 0 0;            background-size: 1rem 1rem;        }                .btn-submit {            margin-top: 1rem;            padding: 0 14px;        }                .btn-submit button {            display: block;            border: 1px solid #8bc5f1;            border-radius: 5px;            background: #108ee9;            width: 100%;            height: 2.25rem;            color: #FFFFFF;            font-size: 1rem;        }                .footer {            margin: 1.52rem 14px 10px 14px;            text-align: center;            font-size: 0.625rem;            line-height: 1.18rem;            color: #8594b4;        }                .footer a {            color: #6565f3;            text-decoration: underline;        }        </style>    </head>    <body>        <div class="top">            <h3 class="name"><!-- <span class="logo"></span> -->{$store_name}</h3>            <div class="money"><strong class="pay_amount">费用查询中</strong></div>            <div class="stateinfo">稍等</div>        </div>        <div class="list on">            <div class="item"><strong class="l">应付金额</strong><span class="r pay_amount">0.00元</span></div>            <div class="item"><strong class="l">已付金额</strong><span class="r" id="real_pay_total">0.00元</span></div>            <div class="item"><strong class="l">优惠金额</strong><span class="r" id="reduce_amount">0.00元</span></div>            <div class="item"><strong class="l">车牌号码</strong><span class="r">{$car_number|safe_car_number}</span></div>            <div class="item"><strong class="l">入场时间</strong><span class="r" id="access_time_in">查找中<span></div>            <div class="item" style="display:none;"><strong class="l">出场时间</strong><span class="r" id="access_time_out">未出场<span></div>            <div class="item"><strong class="l">停车时长</strong><span class="r" id="total_time">查找中</span></div>        </div>        <div class="msg">请于付款后15分钟内离场，超时将加收停车费</div>        <div class="btn-submit">            <button type="button" id="btn_dopay" style="display:none;" onclick="thisApp.createOrder_befter();">立即付款</button>        </div>        <div class="footer" style="display:none;"><!-- 支付宝说不能显示这个 -->            <p>本服务由{$store_name}提供</br>客服电话<a href="tel://{$store_mobile}">{$store_mobile}</a></p>        </div>    </body>    <script type="text/javascript" src="/static/dl/assets/js/jquery.js"></script>    <script src="https://cdn.bootcss.com/jquery-weui/1.2.0/js/jquery-weui.min.js"></script>    <script type="text/javascript">    var total_amount, parking_record_id, ispaying = false;    var thisApp = {        "init": function()        {            switch (thisuserAgent())            {                case "jsapi_alipay":                    break;            }        },        "getFee": function()        {            if (ispaying) return;            $.showLoading("费用查询中");            $.ajax(            {                "url": "{:url('parkingfeeasynchronous')}",                "data":                {                    actionname: "getfee",                    user_id: "{$user_id}", //收费员                    car_number: "{$car_number}"                },                "type": "post",                "dataType": "json",                "success": function(rs)                {                    $.hideLoading();                    //根据支付返回的状态，不同处理                    if (rs.code == 1) //费用查询成功                    {                        $(".pay_amount").html(rs.data.pay_amount + "元");                        $("#access_time_in").html(rs.data.access_time_in);                        //$("#access_time_out").html(rs.data.access_time_out);                        $("#total_time").html(rs.data.total_time);                        $("#real_pay_total").html(rs.data.real_pay_total + "元");                        $("#reduce_amount").html(rs.data.reduce_amount + "元");                        $("#btn_dopay").html("立即付款");                        parking_record_id = rs.data.parking_record_id;                        total_amount = rs.data.pay_amount;                        //alert(rs.data.pay_state);                        if (rs.data.pay_state == 0 && rs.data.pay_amount > 0)                        {                            if (rs.data.access_time_out > 0)                            {                                $(".stateinfo").html("(岗亭)待付款");                            }                            else                            {                                $(".stateinfo").html("待付款");                            }                            $("#btn_dopay").show();                        }                        else                        {                            $(".stateinfo").html("");                            $("#btn_dopay").hide();                        }                    }                    else                    {                        $.closeModal();                        $.alert(                        {                            title: '失败',                            text: rs.message                        });                        $(".pay_amount").html("0.00元");                        $("#access_time_in").html("无记录");                        $("#access_time_out").html("无记录");                        $("#total_time").html("无记录");                        $("#real_pay_total").html("0.00元");                        $("#reduce_amount").html("0.00元");                        $(".stateinfo").html("无车辆");                        $("#btn_dopay").html("查询失败");                        $("#btn_dopay").hide();                    }                },                "error": function(rs)                {                    $.hideLoading();                    $("#btn_dopay").hide();                    $.closeModal();                    $.alert(                    {                        title: '错误',                        text: rs.responseText                    });                }            });        },        createOrder_befter: function()        {            if (!parking_record_id)            {                $.closeModal();                $.alert(                {                    title: '错误',                    text: "当前不可支付"                });                return;            }            //alert(total_amount);            thisApp.createOrder();        },        createOrder: function()        {            ispaying = true;            switch (thisuserAgent())            {                case "jsapi_alipay": //                    $.showLoading("发起支付宝支付");                    $.ajax(                    {                        "url": "/index.php?s=api/pay/jsapipayrequest",                        "data":                        {                            buyer_id: "{$buyer_open_id}",                            user_id: "{$user_id}", //收费员                            guest_brief: "{$car_number}停车缴费",                            subject: "{$store_name}在线缴费", //支付宝不给显示出牌号 //支付宝有格式要求                            car_number: "{$car_number}",                            sale_order_num: parking_record_id,                            create_where: "parking"                        },                        "type": "post",                        "dataType": "json",                        "success": function(rs)                        {                            $.hideLoading();                            //根据支付返回的状态，不同处理                            if (rs.code)                            {                                thisApp.jsapi_alipay_pay(rs.data.trade_no); //唤起收银台JSAPI                            }                            else                            {                                $.closeModal();                                $.alert(                                {                                    title: '错误',                                    text: rs.message                                }, function() {});                            }                        },                        error: function(rs)                        {                            ispaying = false;                            $.hideLoading();                            alert(JSON.stringify(rs));                        }                    });                    break;                case "jsapi_wxpay":                    $.showLoading("发起微信支付");                    $.ajax(                    {                        "url": "/index.php?s=api/pay/jsapipayrequest",                        "data":                        {                            buyer_id: "{$buyer_open_id}",                            user_id: "{$user_id}",                            guest_brief: "{$car_number}停车缴费",                            subject: "{$store_name}在线缴费",                            car_number: "{$car_number}",                            sale_order_num: parking_record_id,                            create_where: "parking"                        },                        "type": "post",                        "dataType": "json",                        "success": function(rs)                        {                            $.hideLoading();                            //根据支付返回的状态，不同处理                            if (rs.code)                            {                                thisApp.jsapi_wxpay_pay(rs.data); //唤起收银台JSAPI                            }                            else                            {                                alert(rs.message);                            }                        },                        error: function(rs)                        {                            $.hideLoading();                            ispaying = false;                            alert(JSON.stringify(rs));                        }                    });                    break;                default:                    ispaying = false;                    alert("未处理的提交订单");            }        },        jsapi_alipay_pay: function(tradeNO)        {            //alert(datajson);            // 通过传入交易号唤起快捷调用方式(注意tradeNO大小写严格)            AlipayJSBridge.call("tradePay",            {                tradeNO: tradeNO            }, function(data)            {                $.hideLoading();                switch (data.resultCode)                {                    case "9000":                        //if(store_pay_after_ad_active==0)                        {                            $.closeModal();                            /*$.alert(                            {                                title: '完成',                                text: "支付成功"                            }, function() {                            });*/                            //支付宝说不能出现自己的支付成功页面                            //window.location.href='/h5/carpark/paysuccessali?total_amount='+total_amount;                            AlipayJSBridge.call('popWindow');                        }                        //else                        {                            //window.location.href='/h5/index/payresult?storeid='+store_id+'&cash='+total_amount;                        }                        //location.href=data.callbackUrl;                        break;                    case "8000":                        ispaying = false;                        $.closeModal();                        $.alert(                        {                            title: '提醒',                            text: "订单正在处理中"                        }, function() {});                        //location.href=data.callbackUrl;                        break;                    default:                        ispaying = false;                        $.closeModal();                        $.alert(                        {                            title: '提醒',                            text: "支付已取消"                        }, function() {});                }            });        },        jsapi_wxpay_pay: function(getBrandWCPayRequestParam)        {            getBrandWCPayRequestParam = (typeof getBrandWCPayRequestParam == "string") ? JSON.parse(getBrandWCPayRequestParam) : getBrandWCPayRequestParam;            WeixinJSBridge.invoke('getBrandWCPayRequest', getBrandWCPayRequestParam, function(res)            {                if (res.err_msg == "get_brand_wcpay_request:ok")                {                    //if(store_pay_after_ad_active==0)                    {                        //alert("支付成功");                    }                    //else                    {                        window.location.href = '/h5/carpark/paysuccesswx?total_amount=' + total_amount;                    }                    // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。                }                else                {                    alert("支付已取消");                }            });        }    };    function thisuserAgent()    {        var userAgent = navigator.userAgent.toLowerCase();        if (userAgent.match(/micromessenger/i) == "micromessenger")        {            return "jsapi_wxpay";        }        else if (userAgent.match(/alipayclient/i) == "alipayclient")        {            return "jsapi_alipay";        }        else        {            return false;        }    }    thisApp.init();    thisApp.getFee();    setInterval(function()    {        thisApp.getFee()    }, 1000 * 59);    </script></html>