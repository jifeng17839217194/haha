<!DOCTYPE html><html>    <head>        <title>{$store.store_name}</title>        <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />        <meta name="apple-mobile-web-app-capable" content="yes">        <meta name="apple-mobile-web-app-status-bar-style" content="black">        <meta content="telephone=no" name="format-detection" />        <meta content="email=no" name="format-detection" />        <script type="text/javascript">        window.jQuery || document.write("<script src='../js/jquery.js'>" + "<" + "/script>");        function thisuserAgent()        {            var userAgent = navigator.userAgent.toLowerCase();            if (userAgent.match(/micromessenger/i) == "micromessenger")            {                return "jsapi_wxpay";            }            else if (userAgent.match(/alipayclient/i) == "alipayclient")            {                return "jsapi_alipay";            }            else            {                return false;            }        }        switch (thisuserAgent())        {            case "jsapi_alipay":                document.write('<script type="text/javascript" src="https://a.alipayobjects.com/g/h5-lib/alipayjsapi/3.0.5/alipayjsapi.inc.min.js"><\/script>');                break;            case "jsapi_wxpay":                document.write('<link rel="stylesheet" type="text/css" href="//res.wx.qq.com/open/libs/weui/1.1.2/weui.min.css">');                break;        }        </script>    </head>    <body>        <form method="get" action="javascript:thisApp.createOrder();">            <div>                <input type="text" max="999999" min="0.01" id="total_amount" value="0.01" name="total_amount">            </div>            <div>                <input type="submit" name="">            </div>        </form>        <div id="rs"></div>        <br />        <br />        <a href="{:url('jsapipay')}?">--刷新--</a>    </body>    <script type="text/javascript">    var thisApp = {        createOrder: function()        {            switch (thisuserAgent())            {                case "jsapi_alipay": //                    ap.showLoading(                    {                        content: '发起支付宝支付',                    });                    $.ajax(                    {                        "url": "/index.php?s=api/pay/jsapipayrequest",                        "data":                        {                            buyer_id: "{$buyer_open_id}",                            user_id:"{:input('user_id')}",                            total_amount: $("#total_amount").val(),                        },                        "type": "post",                        "dataType": "json",                        "success": function(rs)                        {                            ap.hideLoading();                                //根据支付返回的状态，不同处理                            if (rs.code)                            {                                thisApp.jsapi_alipay_pay(rs.data.trade_no); //唤起收银台JSAPI                            }                            else                            {                                ap.alert(                                {                                    title: '错误',                                    content: rs.message,                                    buttonText: '我知道了'                                }, function() {                                });                            }                        }                    });                    break;                case "jsapi_wxpay":                    var loadingToast = function(message)                    {                        $("#loadingToast").remove();                        message && $("body").append($('<div id="loadingToast"><div class="weui-mask_transparent"></div><div class="weui-toast"><i class="weui-loading weui-icon_toast"></i><p class="weui-toast__content">' + message + '</p></div></div>'));                    }                    loadingToast("发起微信支付");                    $.ajax(                    {                        "url": "/index.php?s=api/pay/jsapipayrequest",                        "data":                        {                            buyer_id: "{$buyer_open_id}",                            user_id:"{:input('user_id')}",                            total_amount: $("#total_amount").val(),                        },                        "type": "post",                        "dataType": "json",                        "success": function(rs)                        {                            loadingToast();                            //根据支付返回的状态，不同处理                            if (rs.code)                            {                                thisApp.jsapi_wxpay_pay(rs.data); //唤起收银台JSAPI                            }                            else                            {                                alert(rs.message);                            }                        },                        error:function(rs){                            alert(JSON.stringify(rs));                        }                    });                    break;                default:                    alert("未处理的提交订单");            }        },        jsapi_alipay_pay: function(tradeNO)        {            //alert(datajson);            // 通过传入交易号唤起快捷调用方式(注意tradeNO大小写严格)            AlipayJSBridge.call("tradePay",            {                tradeNO: tradeNO            }, function(data)            {                ap.hideLoading();                //$("#rs").html(JSON.stringify(data));                switch (data.resultCode)                {                    case "9000":                        ap.alert(                        {                            title: '完成',                            content: "支付成功",                            buttonText: '我知道了'                        }, function() {                        });                        //location.href=data.callbackUrl;                        break;                    case "8000":                        ap.alert(                        {                            title: '提醒',                            content: "订单正在处理中",                            buttonText: '我知道了'                        }, function() {                        });                        //location.href=data.callbackUrl;                        break;                    default:                        ap.alert(                        {                            title: '提醒',                            content: "支付已取消",                            buttonText: '我知道了'                        }, function() {                        });                }            });        },        jsapi_wxpay_pay: function(getBrandWCPayRequestParam)        {            getBrandWCPayRequestParam = (typeof getBrandWCPayRequestParam=="string")?JSON.parse(getBrandWCPayRequestParam):getBrandWCPayRequestParam;            WeixinJSBridge.invoke('getBrandWCPayRequest', getBrandWCPayRequestParam, function(res)            {                if (res.err_msg == "get_brand_wcpay_request:ok")                {                    alert("支付完成");                    // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。                   }                else                {                    alert("支付已取消");                }            });        }    }    </script></html>