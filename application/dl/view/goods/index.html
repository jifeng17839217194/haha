{extend name="common/common"} {block name="breadcrumbs"}
<script type="text/javascript">
function yongjingbili(goods_yongjin,goods_price_now) {
    document.write((accMul(accDiv(goods_yongjin,goods_price_now),100)).toFixed(2) + "%");
}
</script>
<style type="text/css">
.title{
    overflow: hidden;
text-overflow:ellipsis;
white-space: nowrap;
width: 300px;
}
</style>
<ul class="breadcrumb">
    <li class="active">
        <i class="ace-icon fa fa-home home-icon"></i>
        <span _href="#">软件服务中心</span>
    </li>
    <li class="active">
        管理
    </li>
</ul>
<!-- #section:basics/content.searchbox -->
<div class="nav-search nav-positions" id="nav-search">
    <form class="form-search form-inline">
    	<div class="form-group">
                  <select id="mainClass" name="goods_class_pid" data-first-title="选择分类">
				        <option value="">请选择</option>
				        {volist name="ClassList" id="vo"}
				        <option value="{$vo.goods_class_id}" {if condition="$vo.goods_class_id eq input('goods_class_pid')"}selected{/if}>{$vo.goods_class_name}</option>
				        {/volist}
				      </select>
				      {volist name="ClassList" id="vo"}
				      {notempty name="$vo.son"}
				      <select name="goods_class_id{$vo.goods_class_id}" class="sonClass sonClass_{$vo.goods_class_id}" data-first-title="选择分类" style="display:none;">
				        <option value="">请选择</option>
				        {volist name="vo.son" id="vo2"}
				        <option value="{$vo2.goods_class_id}" {if condition="$vo2.goods_class_id eq input('goods_class_id')"}selected{/if}>{$vo2.goods_class_name}</option>
				        {/volist}
				      </select>
				      {/notempty}
				      {/volist}
        </div>
        <script>
				$("#mainClass").change(function(){
	               $(".sonClass").hide();
	               $(".sonClass").attr("name","goods_class_id1");
	               $(".sonClass_"+$("#mainClass").val()).show();
	               $(".sonClass_"+$("#mainClass").val()).attr("name","goods_class_id");
	            });
		        $("#mainClass").change();
				</script>
        
        <span class="input-icon">
            <input type="text" placeholder="关键词" name="keyword" value="{:input('get.keyword')}" class="nav-search-input" autocomplete="off" />
            <i class="ace-icon fa fa-search nav-search-icon"></i>
        </span>
        <input type="submit" class="btn btn-info btn-xs " value="搜索">
        {if checkActionAuth()}
        <a href="{:url('add')}" class="btn btn-info btn-xs "><i class="glyphicon glyphicon-plus"></i>新增</a>
        {/if}
    </form>
</div>
{/block} {block name="page-content"}
<form action="" id="form2" method="POST">
    <table class="table table-striped table-bordered table-hover">
        <thead>
            <tr>
                <th width="20">
                    <input class="ace" onclick="javascript:thisApp.selectByChecked($(this),'goods_id');" type="checkbox" />
                    <span class="lbl"></span>
                </th>
                <th width="50">ID</th>
                <th>标题</th>
                <th>图片</th>
                <th>券后价</th>
                <th>佣金</th>
                <th>佣金比例</th>
                <th>数据来源/更新</th>
                <th width="150">状态</th>
                <th width="151"><i class="ace-icon fa fa-clock-o bigger-110 hidden-480"></i>新增时间</th>
                <th width="50">排序</th>
                <th width="120">操作</th>
            </tr>
        </thead>
        {volist name="lists" id="vo"}
        <tr>
            <td align="center">
                <input class="ace" name="goods_id[]" type="checkbox" value="{$vo.goods_id}" />
                <span class="lbl"></span>
            </td>
            <td>{$vo.goods_id}</td>
            <td align="center" width="80">
                <img src="//img.alicdn.com/{$vo.goods_small_image}_80x80.jpg" width="80" height="80">
            </td>
            <td style="width:300px;"><div class="title">{$vo.goods_title}</div>
            <a href="https://uland.taobao.com/coupon/edetail?activityId={$vo.goods_quan_activity_id}&pid=mm_15817731_5244158_117404736&itemId={$vo.goods_tabao_id}&src=zzkjapp&dx=1" target="_blank">二合一地址</a>
            <br />
            券剩余：{$vo.goods_quan_wait_sale_count}
            </td>
            <td>
            {$vo.goods_price_now}
            </td>
            <td>
            {$vo.goods_yongjin}
            </td>
            <td><script type="text/javascript">yongjingbili({$vo.goods_yongjin},{$vo.goods_price_now})</script></td>
            <td>
            <a href="http://{$vo.goods_from_website}" target="_blank">{$vo.goods_from_website}</a><br />
            <a href="http://{$vo.goods_update_website}" target="_blank">{$vo.goods_update_website}</a>
            </td>
            <td>
            <a href="https://uland.taobao.com/coupon/edetail?activityId={$vo.goods_quan_activity_id}&pid=mm_15817731_5244158_117404736&itemId={$vo.goods_tabao_id}&src=zzkjapp&dx=1" data-goods-id="{$vo.goods_id}" class="checkQuanStatus" target="_blank">正在检查券的状态</a>
            <br />
            上次检查：<br />{$vo.goods_last_check_quan_time|date="Y-m-d H:i:s",###}
            </td>
            <td>{$vo.goods_addtime}<br/>{$vo.goods_updatetime}</td>
            <td>
                <input type="text" title="排序" readonly class="input-mini" ajax='{"data":"goods_id={:$vo['goods_id']}","url":"{:url('sortnum')}","prompt":"text"}' value="{:$vo['goods_sortnum']}">
            </td>
            <td>
                {if checkActionAuth('','add')}
                <!-- <a href="{:url('add?goods_id='.$vo['goods_id'])}" class="tooltip-success" data-rel="tooltip" title="编辑"><span class="green"><i class="ace-icon fa fa-pencil-square-o bigger-120"></i></span>编辑</a> &nbsp; -->
                {/if}
                {if checkActionAuth()}
                <a ajax='{"confirm":"删除吗？","url":"{:url("delete?goods_id=" .$vo[ "goods_id"])} "}' href="javascript:; " class="tooltip-error "><span class="red "><i class="ace-icon fa fa-trash-o bigger-120 "></i></span>删除</a>
                {/if}
            </td>
        </tr>
        {/volist}
    </table>
</form>
<div class="pull-left ">
    {if checkActionAuth()}
        <a ajax='{"confirm":"删除吗？ ","data-form":"#form2 ","url":"{:url("delete")}"}' class="btn btn-white btn-inverse btn-sm " href="javascript:; ">删除</a>
    {/if}
    <!-- <a onclick="doloadtable() " class="btn btn-white btn-inverse btn-sm " href="javascript:; ">
                                        导出表格
                                    </a> -->
</div>
<div class="pull-right ">
    共{$lists->total()}条记录
    <br /> {$lists->render()}
</div>
<div class="clearfix ">
</div>
</div>
<script type="text/javascript">
var checkQuanStatusObj = document.querySelectorAll(".checkQuanStatus");
for (var i = checkQuanStatusObj.length - 1; i >= 0; i--) {
    var dofun=function(goods_id,i){
        setTimeout(function(){
            $.ajax({
                url:"{:url('checkquanstatus')}",
                dataType:"json",
                data:"goods_id="+goods_id,
                success:function(rs) {
                    if (rs.code==true) {
                        document.querySelectorAll(".checkQuanStatus")[i].innerHTML = "成功";
                    } else {
                        document.querySelectorAll(".checkQuanStatus")[i].innerHTML = "<font color='red'>失效了</font>";
                    }
                }
            })
        },i*100);
    };
    dofun(checkQuanStatusObj[i].getAttribute("data-goods-id"),i);
}
</script>
{/block}
